<?php

namespace App\Console\Commands\CacheJson;

use App\Models\MainInventory;
use Illuminate\Console\Command;

class AddBostonSuffolkcache extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'add-boston-suffolk-cache';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Cache the Boston - Suffolk Zip Code data';

    /**
     * Execute the console command.
     */
    public function handle()
    {

        // $cacheFilePath = storage_path('app/san_antonio_county.json');

        // // Check if the file exists
        // if (!file_exists($cacheFilePath)) {
        //     return response()->json([
        //         'status' => 'error',
        //         'message' => 'Cache file not found'
        //     ], 404);
        // }

        // // Read the JSON file
        // $jsonData = file_get_contents($cacheFilePath);
        // dump(json_decode($jsonData));
        // dd('53 bilion');
        // // Convert to JSON response
        // return response()->json(json_decode($jsonData), 200);

        // $zip_code = [
        //     "00501", "00544", "02108", "02109", "02110", "02111", "02112", "02113", "02114", "02115", "02116",
        //     "02117", "02118", "02119", "02120", "02121", "02122", "02123", "02124", "02125", "02126", "02127",
        //     "02128", "02129", "02130", "02131", "02132", "02133", "02134", "02135", "02136", "02137", "02150",
        //     "02151", "02152", "02163", "02196", "02199", "02201", "02203", "02204", "02205", "02206", "02210",
        //     "02211", "02215", "02217", "02222", "02241", "02266", "02283", "02284", "02293", "02297", "02298",
        //     "06390", "11701", "11702", "11703", "11704", "11705", "11706", "11707", "11713", "11715", "11716",
        //     "11717", "11718", "11719", "11720", "11721", "11722", "11724", "11725", "11726", "11727", "11729",
        //     "11730", "11731", "11733", "11738", "11739", "11740", "11741", "11742", "11743", "11746", "11747",
        //     "11749", "11751", "11752", "11754", "11755", "11757", "11760", "11763", "11764", "11766", "11767",
        //     "11768", "11769", "11770", "11772", "11775", "11776", "11777", "11778", "11779", "11780", "11782",
        //     "11784", "11786", "11787", "11788", "11789", "11790", "11792", "11794", "11795", "11796", "11798",
        //     "11901", "11930", "11931", "11932", "11933", "11934", "11935", "11937", "11939", "11940", "11941",
        //     "11942", "11944", "11946", "11947", "11948", "11949", "11950", "11951", "11952", "11953", "11954",
        //     "11955", "11956", "11957", "11958", "11959", "11960", "11961", "11962", "11963", "11964", "11965",
        //     "11967", "11968", "11969", "11970", "11971", "11972", "11973", "11975", "11976", "11977", "11978",
        //     "11980"

        // ];

        $zip_code = [
            "02113","02109","02203","02222","02455","02117","02283","02241","02211","02123","02137","02297","02201","02293","02196",
            "02217","02206","02284","02204","02112","02110","02114","02108","02205","02111","02129","02142","02141","02133","02116",
            "02210","02298","02199","02118","02128","02127","02115","02238","02139","02143","02145","02150","02212","02149","02215",
            "02120","02119","02125","02163","02446","02134","02456","02152","02138","02447","02144","02153","02121","02140","02148",
            "02122","02151","02445","02130","02155","02135","02171","02124","02156","02187","02467","02472","02176","02474","02126",
            "02475","02477","02471","02131","02458","02478","02170","02476","01910","01906","01890","02180","02460","01908","02459",
            "02495","02132","02269","02479","02452","01905","02461","02136","01901","01903","02169","02186","02465","02453","02464",
            "02454","01815","01813","02468","01888","01880","01902","01904","02466","02027","02191","02494","01801","02420","02026",
            "02462","02421","02451","02045","01907","02185","01805","02492","02457","02184","02481","01867","01940","02188","02189",
            "01960","02493","01803","02090","01970","01961","02021","01971","02482","02368","01945","01731","02043","01773","02044",
            "01866","02062","01730","01889","02030","02190","01864","01887","02025","01937","02343","01923","01778","02018","01760",
            "01865","01821","02322","01949","02032","01742","02060","02072","01915","01822","02055","02351","01965","02370","02066",
            "02081","02052","02067","01770","01984","01776","01862","02061","01741","01876","01704","01705","01703","02302","01983",
            "02303","02305","02304","01701","02339","02301","02040","01936","01810","02382","01982","01812","01899","05501","01702",
            "02054","01944","01754","02357","02059","02071","01720","01845","01824","02356","01921","01718","01852","02051","02056",
            "01721","01746","02035","01851","01843","02358","01853","01929","02341","01745","01775","02375","02333","02334","01885",
            "01850","02053","02379","01840","01842","01938","02047","01841","02359","02337","01854","02327","01749","02050","01460",
            "01772","01863","01886","01833","01719","01752","02048","01969","02065","01826","01844","01748","02350","02325","02038",
            "01930","01931","01834","02093","01835","01784","02324","02338","01879","01922","02762","01757","01831","01451","01740",
            "02020","02041","01951","02332","02766","02070","03076","01581","02019","01503","02767","01432","01747","01832","01830",
            "02331","01985","01532","02367","02761","02763","02712","01966","01467","02768","01434","02760","01756","03079","01568",
            "02364","01827","02780","01450","02703","01523","01950","01860","01510","01561","03087","03051","03865","03811","01504",
            "03060","02344","02349","02348","01464","01472","03073","03062","01505","01536","01519","01534","02355","01546","02895",
            "01913","01545","02864","02718","02362","02361","02346","03858","01560","03859","01463","03061","02838","01952","01529",
            "02802","01588","01525","02764","01538","03064","03826","03841","02347","02865","01655","01569","02896","02876","02861",
            "02330","02863","03874","03063","01583","01604","02779","01564","01462","02769","02862","03827","01653","03848","03049",
            "03038","02860","01606","02715","01453","01605","03041","02771","01607","01469","01614","01601","01613","01615","03819",
            "01608","03053","01527","03052","02916","01590","02381","01610","03873","02826","02702","01609","02917","02360","01526",
            "03843","03844","02906","02904","01586","03842","02830","02366","01520","02918","01474","03054","01602","03033","01420",
            "02912","01603","03833","02908","02911","02858","02914","02902","02901","02940","02345","02839","01516","01522","02903",
            "02828","01501","02726","02717","02909","03036","01611","02829","01541","02777","03044","02915","02576","02770","02905",
            "02907","02720","03862","02859","02824","02919","03055","01540","03103","03871","02725","03048","03031","02885","01537",
            "01524","02910","02806","01431","01612","02571","01542","03109","02745","02814","03885","03032","01473","02743","01570",
            "02538","02722","02888","02920","01543","03110","02723","03077","03856","02738","03042","03840","02724","03870","02558",
            "03101","02921","03108","03105","03111","02857","03040","02562","02721","01430","01562","02809","03086","02746","03857",
            "02561","03104","03057","02889","02657","01509","02747","06277","02887","03071","01452","03102","01507","01571","02739",
            "01440","02886","02532","03801","02553","01441","02823","03034","01508","02741","02742","02831","02740","01068","06255",
            "03804","03803","03802","06246","03854","06245","02825","06262","02719","02815","01438","02559","02790","01515","02893",
            "03106","03045","06243","03082","03084","06260","02878","03861","02744","03824","03290","03070","01535","01468","02534",
            "02872","06233","01074","02563","02652","01005","06244","03905","03904","02644","02537","02818","03461","02714","06241",
            "01475","01550","02556","02871","03037","06267","01506","01531","01436","02816","02542","01094","01566","02748","03903",
            "03823","02801","06281","02574","03291","06258","06263","01518","03911","03458","03820","06239","02668","02852","01585",
            "03047","03821","02827","02666","03046","01031","01037","02791","03822","02648","03304","03043","03825","03275","03909",
            "02536","02540","02649","01331","02837","01366","03261","06377","03468","02842","01083","06259","02817","03869","06230",
            "03281","06282","02635","03452","02630","03234","03910","02541","02841","01521","01092","02655","02637","02632","02667",
            "06234","02835","02543","01010","02634","06387","06354","06373","03839","03447","06332","02638","01368","03878","02840",
            "02877","02874","03815","02675","02663","02641","03908","02822","03442","02601","06242","01082","03902","03866","02672",
            "03302","03305","02713","03444","03884","02647","03449","01081","03258","06374","02660","01355","03867","02651","03301",
            "02673","02892","03907","01069","02664","06278","02881","01364","03901","03868","03229","03450","03218","03465","01079",
            "03263","02898","02631","02642","06247","06331","02670","04054","06076","06077","02883","01057","01009","02639","03440",
            "06384","03242","06235","02880","03455","02882","02671","02557","03244","02645","06075","01080","02643","03835","03307",
            "02812","02662","03906","02832","01378","02568","03225","01007","02879","04090","02875","02836","02646","03457","02873",
            "02653","06279","01072","02575","01379","02661","02552","06264","02659","06351","03470","01380","06256","01002","03446",
            "02833","02894","06250","03303","01344","06350","04027","02650","01095","06280","02633","06330","06269","01036","03469",
            "02669","03224","03464","02539","01056","06265","02535","06383","06268","04073","01054","03435","02804","03837","02813",
            "01360","03445","03851","01349","01033","06266","02808","06226","06084","01059","01004","06359","03431","06251","01003",
            "04043","01129","06071","01351","06380","03237","01128","03221","03809","04094","06365","01347","03855","01151","04014",
            "03441","01119","06254","01354","03887","04083","01028","01375","03278","01022","03448","06238","03280","03456","01376",
            "06360","01116","01118","03462","04046","03268","03276","06072","06389","06029","01075","01035","01020","01111","03273",
            "01109","03220","06338","06237","03852","02891","01104","03298","01038","03451","03810","01108","05354","06249","03443",
            "03299","06336","03252","03272","06339","01373","01105","04002","01066","01060","01302","04001","06379","01106","01013",
            "06232","01103","01041","06334","01342","01138","01102","01115","01139","01152","01144","01301","01093","01014","01021",
            "06066","03235","01063","06372","01101","06378","01337","01061","03260","01107","01088","01199","06082","03289","01040",
            "03255","06335","01090","03467","06043","04076","03605","03466","04006","01001","01089","06016","04005","06355","06083",
            "06382","03602","03247","03216","06248","04007","05303","01039","05302","05304","03752","01062","03249","06353","06388",
            "03872","04087","03608","03607","01341","06231","03231","03894","01053","03896","06088","06042","04063","06370","03233",
            "02807","01030","03269","06080","03246","06045","06041","06349","03604","06340","06078","04072","06074","06040","04030",
            "03287","01027","05159","06375","04064","03257","06028","01073","03601","06415","06420","01370","06096","03782","06447",
            "01096","03243","05346","06474","05158","04095","03830","05357","01086","01340","06320","03853","03609","03754","06006",
            "06025","01085","04061","04056","06064","06390","02584","06033","06093","06128","05301","06385","04004","03230","04042",
            "06108","03253","01330","06095","01338","03773","02554","05358","01032","03603","06118","01077","06138","03256","03751",
            "06026","05154","06199","04093","04074","06333","06104","04070","03864","05362","01012","06101","03284","06120","05101",
            "03850","06423","06073","04048","05344","06469","06115","06103","03816","06183","06424","05342","01346","05345","01071",
            "06112","06154","06152","06002","01084","06357","06081","06167","06142","06144","06143","06160","06145","06150","06146",
            "06176","06153","06129","06132","06155","06134","06147","06131","06141","06126","06140","06127","06161","06123","06180",
            "06156","06151","03743","06102","06114","06035","06105","05141","03222","03254","04107","01097","05351","06109","06106",
            "02564","03882","06133","01050","01339","04028","06480","06414","04106","06060","06456","01026","03226","04047","06119",
            "03240","06439","04049","06371","03753","01070","06117","06067","06376","05353","06070","01098","05341","06110","04098",
            "05146","06090","05361","03814","04020","06107","06438","05156","04102","06089","04038","03217","04101","06416","06111",
            "01008","04116","04123","04124","04122","04104","04112","04092","06092","01367","06027","06426","01011","03264","01034",
            "04085","06412","03245","06409","05030","06030","06459","04103","04108","06457","06417","01243","05363","03746","04082"
        ];


        // $zip_code = [
        //                 "02113", "02109", "02203", "02222", "02211", "02297", "02217", "02283", "02241", "02293", "02284", "02137",
        //                 "02117", "02196", "02201", "02204", "02206", "02455", "02112", "02123", "02110", "02114", "02108", "02205",
        //                 "02111", "02129", "02142", "02141", "02133", "02116", "02210", "02298", "02199", "02118", "02128", "02127",
        //                 "02115", "02238", "02139", "02143", "02145", "02150", "02212", "02149", "02215", "02120", "02119", "02125",
        //                 "02163", "02446", "02134", "02456", "02152", "02138", "02447", "02144", "02153", "02121", "02140", "02148",
        //                 "02122", "02151", "02445", "02130", "02155", "02135", "02171", "02124", "02156", "02187", "02467", "02472",
        //                 "02176", "02474", "02126", "02475", "02477", "02471", "02131", "02458", "02478", "02170", "02476", "01910",
        //                 "01906", "01890", "02180", "02460", "01908", "02459", "02495", "02132", "02269", "02479", "02452", "01905",
        //                 "02461", "02136", "01901", "01903", "02465", "02169", "02186", "02453", "02464", "02454", "01813", "01815",
        //                 "02468", "01888", "01880", "01902", "01904", "02466", "02027", "02191", "02494", "01801", "02420", "02026",
        //                 "02462", "02421", "02451", "02045", "01907", "01805", "02185", "02492", "02457", "02184", "02481", "01867",
        //                 "01940", "02188", "02189", "02493", "01960", "01803", "02090", "01970", "01961", "02021", "01971", "02482",
        //                 "01945", "02368", "01731", "02043", "01773", "02044", "01866", "01730", "02062", "02030", "01889", "02190",
        //                 "01864", "01887", "02025", "01937", "02343", "01923", "01778", "02018", "01760", "01865", "01821", "02322",
        //                 "01949", "02032", "01742", "02060", "02072", "01915", "01822", "02055", "02351", "01965", "02370", "02066",
        //                 "02081", "02052", "01770", "02067", "01984", "01776", "01862", "02061", "01741", "01876", "01703", "01704",
        //                 "01705", "02302", "01983", "02304", "02305", "02303", "01701", "02339", "02301", "02040", "01936", "01810",
        //                 "02382", "01982", "01899", "01812", "05501", "01702", "02054", "01944", "01754", "02059", "02357", "02071",
        //                 "01720", "01845", "01824", "02356", "01921", "01718", "01852", "02051", "02056", "01721", "01746", "02035",
        //                 "01851", "02358", "01843", "01853", "01929", "01745", "01775", "02341", "02375", "02333", "02334", "01885",
        //                 "01850", "02053", "02379", "01840", "01842", "01938", "02047", "01841", "02359", "01854", "02337", "01749",
        //                 "02327", "02050", "01460", "01772", "01863", "01886", "01833", "01719", "01752", "02048", "01969", "02065",
        //                 "01826", "01748", "01844", "02350", "02325", "02038", "01930", "01931", "01834", "02093", "01835", "01784",
        //                 "02324", "01879", "02338", "01922", "02762", "01757", "01451", "01831", "01740", "02020", "02041", "01951",
        //                 "02332", "02766", "01581", "02070", "03076", "02019", "01503", "02767", "01432", "01747", "01832", "01532",
        //                 "01830", "02331", "01985", "02367", "02761", "02763", "02712", "01966", "01467", "02768", "01434", "01756",
        //                 "02760", "03079", "01568", "02364", "01827", "02780", "01450", "02703", "01523", "01950", "01510", "01860",
        //                 "01561", "03051", "03087", "03865", "01504", "03060", "03811", "02349", "02344", "02348", "01464", "01472",
        //                 "03073", "03062", "01505", "01536", "01519", "01546", "01534", "02355", "02895", "01545", "01913", "02864",
        //                 "02362", "02361", "02718", "01560", "02346", "03858", "01463", "03859", "03061", "02838", "01952", "01529",
        //                 "02802", "01588", "01525", "02764", "01538", "03064", "03826", "03841", "02347", "01655", "02865", "01569",
        //                 "02896", "02876", "02861", "02330", "02863", "03063", "03874", "01583", "01604", "01564", "01462", "02779",
        //                 "02769", "01653", "02862", "03827", "03848", "03049", "01606", "03038", "02860", "01453", "01605", "02715",
        //                 "03041", "01607", "02771", "01469", "01613", "01614", "01601", "01615", "01608", "01527", "03053", "03819",
        //                 "01590", "03052", "02916", "02381", "01610", "03873", "01609", "02826", "01526", "02917", "02702", "02360",
        //                 "03843", "03844", "02906", "02904", "01586", "02830", "03842", "01520", "02366", "01474", "03054", "02918",
        //                 "01602", "01420", "03033", "01603", "02912", "02858", "02911", "02908", "03833", "02914", "02345", "02901",
        //                 "02839", "02940", "02902", "01522", "01516", "02903", "02828", "01501", "02726", "02717", "02909", "03036",
        //                 "01611", "01541", "02829", "02777", "03044", "02915", "02576", "02770", "02905", "02907", "02720", "02859",
        //                 "02824", "03862", "02919", "01540", "03055", "03103", "03871", "03048", "02725", "03031", "01537", "01524",
        //                 "01612", "01431", "02910", "02885", "02806", "01542", "02571", "03109", "02814", "02745", "01473", "03032",
        //                 "03885", "02743", "01570", "02538", "02722", "01543", "02888", "02920", "03110", "02723", "03077", "03856",
        //                 "02738", "03042", "03840", "02724", "03870", "02558", "03101", "02921", "03108", "03105", "03111", "02857",
        //                 "03040", "02562", "02721", "01562", "01430", "03086", "02809", "02746", "02561", "03104", "03857", "03057",
        //                 "02889", "02657", "01509", "06277", "02747", "03071", "02887", "01452", "01507", "03102", "01571", "01440",
        //                 "02739"

        // ];

        $chunkSize = 1000; // Adjust as needed
        $cacheFilePath = storage_path('app/suffolk_county.json'); // File path for caching


        // Clear old cache file if it exists
        if (file_exists($cacheFilePath)) {
            unlink($cacheFilePath);
        }

        // Open the file in append mode
        $file = fopen($cacheFilePath, 'a');

        // Write an opening bracket for JSON array
        fwrite($file, '[');

        $firstChunk = true; // Flag to handle commas between records
        // $mainInventory = MainInventory::whereIn('zip_code',$zip_code)->get();

        $mainInventory = MainInventory::select('id', 'deal_id', 'vin', 'year', 'make', 'model', 'price', 'title', 'miles', 'price_rating', 'zip_code', 'latitude', 'longitude', 'payment_price', 'type', 'engine_details', 'payment_price', 'exterior_color', 'interior_color', 'fuel', 'body_formated','drive_info', 'transmission','stock_date_formated')
            ->with([
                'dealer' => function ($query) {
                    $query->select('dealer_id', 'name', 'state', 'brand_website', 'rating', 'review', 'phone', 'city', 'zip', 'role_id')
                        ->addSelect('id'); // Add id explicitly to avoid conflict
                },
                'additionalInventory' => function ($query) {
                    $query->select('main_inventory_id', 'local_img_url')  // Only necessary columns
                        ->addSelect('id'); // Add id explicitly to avoid conflict
                },
                'mainPriceHistory' => function ($query) {
                    $query->select('main_inventory_id', 'change_amount') // Only necessary columns
                        ->addSelect('id'); // Add id explicitly to avoid conflict
                }
            ])->whereIn('zip_code', $zip_code)
            // ->get();;
            ->chunk($chunkSize, function ($chunk, $index) use ($file, &$firstChunk) {
                foreach ($chunk as $dealer) {
                    // Serialize each dealer as JSON
                    $dealerJson = json_encode($dealer);

                    // Add a comma between records (except for the first one)
                    if (!$firstChunk) {
                        fwrite($file, ',');
                    } else {
                        $firstChunk = false;
                    }

                    // Write the dealer JSON to the file
                    fwrite($file, $dealerJson);
                }
            });

        fwrite($file, ']');

        // Close the file
        fclose($file);

        $this->info('Boston - Suffolk data cached successfully in file: ' . $cacheFilePath);
        // 78228
    }
}
